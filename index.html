<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculator with Claude AI & History</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #fff6fe;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px;
      gap: 20px;
      flex-wrap: wrap;
    }

    .calculator {
      background: #ffffff;
      width: 100%;
      max-width: 320px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }

    .side-panel {
      background: #ffffff;
      width: 100%;
      max-width: 400px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }

    .panel-tabs {
      display: flex;
      background: #f0f0f0;
      border-bottom: 2px solid #dc6bba;
    }

    .panel-tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      transition: all 0.3s;
    }

    .panel-tab.active {
      background: #ffffff;
      color: #dc6bba;
    }

    .panel-content {
      display: none;
      padding: 20px;
      height: 600px;
      overflow-y: auto;
    }

    .panel-content.active {
      display: flex;
      flex-direction: column;
    }

    .chat-area {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 15px;
      padding: 10px;
      background: #fafafa;
      border-radius: 8px;
      min-height: 400px;
    }

    .message {
      margin-bottom: 12px;
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 85%;
      word-wrap: break-word;
      line-height: 1.5;
    }

    .user-message {
      background: #dc6bba;
      color: white;
      margin-left: auto;
      text-align: right;
    }

    .ai-message {
      background: #fcdcf9;
      color: #333;
    }

    .loading {
      background: #fcdcf9;
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 85%;
      font-style: italic;
      color: #666;
    }

    .input-area {
      display: flex;
      gap: 10px;
    }

    .ai-input {
      flex: 1;
      padding: 12px;
      border: 2px solid #dc6bba;
      border-radius: 8px;
      font-size: 14px;
      font-family: 'Segoe UI', sans-serif;
      outline: none;
    }

    .ai-input:focus {
      border-color: #a34582;
    }

    .send-btn {
      padding: 12px 16px;
      background: #dc6bba;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .send-btn:hover {
      background: #c95aa7;
    }

    .send-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .equation-solver {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .equation-input-section {
      background: #fafafa;
      padding: 15px;
      border-radius: 8px;
    }

    .equation-input-section h3 {
      margin-bottom: 10px;
      color: #333;
      font-size: 16px;
    }

    .equation-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #dc6bba;
      border-radius: 8px;
      font-size: 16px;
      font-family: 'Courier New', monospace;
      outline: none;
    }

    .equation-examples {
      margin-top: 10px;
      font-size: 12px;
      color: #666;
    }

    .equation-examples div {
      margin-top: 5px;
    }

    .solve-btn {
      width: 100%;
      padding: 15px;
      background: #a34582;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 16px;
      transition: all 0.2s;
    }

    .solve-btn:hover {
      background: #8f3b71;
    }

    .solve-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .solution-area {
      background: #fafafa;
      padding: 15px;
      border-radius: 8px;
      min-height: 200px;
    }

    .solution-area h3 {
      margin-bottom: 10px;
      color: #333;
      font-size: 16px;
    }

    .solution-content {
      font-size: 14px;
      line-height: 1.6;
      color: #333;
      white-space: pre-wrap;
    }

    .combined-history {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .history-section {
      background: #fafafa;
      padding: 15px;
      border-radius: 8px;
    }

    .history-section h3 {
      font-size: 16px;
      margin-bottom: 15px;
      color: #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .clear-btn {
      background: #dc6bba;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .clear-btn:hover {
      background: #c95aa7;
    }

    .history-item, .memory-item {
      background: white;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      border-left: 4px solid #dc6bba;
      cursor: pointer;
      transition: all 0.2s;
    }

    .history-item:hover, .memory-item:hover {
      background: #ffe6fc;
      transform: translateX(5px);
    }

    .history-expression {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }

    .history-result {
      font-size: 20px;
      color: #333;
      font-weight: 600;
    }

    .no-history, .no-memory {
      color: #888;
      text-align: center;
      padding: 20px;
      font-size: 14px;
    }

    .header {
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .mode {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .history-toggle {
      background: #dc6bba;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .history-toggle:hover {
      background: #c95aa7;
    }

    .display-area {
      padding: 20px 16px;
      text-align: right;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      background: #fafafa;
    }

    .history-text {
      color: #888;
      font-size: 14px;
      margin-bottom: 8px;
      min-height: 20px;
    }

    .display {
      background: transparent;
      border: none;
      color: #000;
      font-size: 48px;
      font-weight: 600;
      text-align: right;
      width: 100%;
      outline: none;
    }

    .memory-buttons {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 1px;
      padding: 8px 0;
      background: #f0f0f0;
    }

    .memory-btn {
      background: #ffffff;
      border: none;
      color: #666;
      font-size: 13px;
      padding: 10px;
      cursor: pointer;
      font-family: 'Segoe UI', sans-serif;
      transition: all 0.2s;
    }

    .memory-btn:hover {
      background: #ffe6fc;
      color: #dc6bba;
    }

    .memory-btn:active {
      background: #fcdcf9;
    }

    .buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1px;
      padding: 0;
      background: #e0e0e0;
    }

    button {
      height: 60px;
      font-size: 20px;
      border: none;
      cursor: pointer;
      background: #fcdcf9;
      color: #000;
      font-family: 'Segoe UI', sans-serif;
      transition: all 0.2s;
      font-weight: 500;
    }

    button:hover {
      filter: brightness(0.95);
    }

    button:active {
      filter: brightness(0.85);
      transform: scale(0.98);
    }

    button.function {
      background: #fcdcf9;
      color: #000;
      font-size: 18px;
    }

    button.operator {
      background: #dc6bba;
      color: #fff;
      font-size: 24px;
      font-weight: 600;
    }

    button.number {
      background: #fcdcf9;
      font-size: 24px;
    }

    button.equal {
      background: #a34582;
      color: white;
      font-size: 24px;
      font-weight: 700;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 1; }
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      
      .calculator, .side-panel {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="calculator">
    <div class="header">
      <div class="mode">Standard</div>
      <button class="history-toggle" id="historyToggle">üíæ Memory</button>
    </div>

    <div class="display-area">
      <div class="history-text" id="history">&nbsp;</div>
      <input type="text" class="display" id="display" value="0" readonly>
    </div>

    <div class="memory-buttons">
      <button class="memory-btn" id="mc">MC</button>
      <button class="memory-btn" id="mr">MR</button>
      <button class="memory-btn" id="mAdd">M+</button>
      <button class="memory-btn" id="mSub">M‚àí</button>
      <button class="memory-btn" id="ms">MS</button>
    </div>

    <div class="buttons">
      <button class="function" id="percent">%</button>
      <button class="function" id="ce">CE</button>
      <button class="function" id="clear">C</button>
      <button class="function" id="back">‚å´</button>

      <button class="function" id="recip">¬π‚ÅÑ‚Çì</button>
      <button class="function" id="square">x¬≤</button>
      <button class="function" id="sqrt">¬≤‚àöx</button>
      <button class="operator" id="divide">√∑</button>

      <button class="number" id="n7">7</button>
      <button class="number" id="n8">8</button>
      <button class="number" id="n9">9</button>
      <button class="operator" id="multiply">√ó</button>

      <button class="number" id="n4">4</button>
      <button class="number" id="n5">5</button>
      <button class="number" id="n6">6</button>
      <button class="operator" id="subtract">‚àí</button>

      <button class="number" id="n1">1</button>
      <button class="number" id="n2">2</button>
      <button class="number" id="n3">3</button>
      <button class="operator" id="add">+</button>

      <button class="function" id="negate">+/‚àí</button>
      <button class="number" id="n0">0</button>
      <button class="number" id="decimal">.</button>
      <button class="equal" id="equals">=</button>
    </div>
  </div>

  <div class="side-panel">
    <div class="panel-tabs">
      <div class="panel-tab active" data-tab="chatgpt">üí¨ AI Assistant</div>
      <div class="panel-tab" data-tab="equation">üìê Equations</div>
      <div class="panel-tab" data-tab="history">üìã History</div>
    </div>

    <div class="panel-content active" id="chatgptPanel">
      <div class="chat-area" id="chatArea">
        <div class="message ai-message">
          <strong>üëã Hi! I'm Claude, your comprehensive AI math assistant.</strong>
          <p style="margin-top: 8px; font-size: 14px;">I can help you with:</p>
          <ul style="margin-top: 5px; margin-left: 20px; font-size: 13px;">
            <li>Explaining ANY math concept (prime numbers, fractions, algebra, calculus, etc.)</li>
            <li>Solving complex math problems step-by-step</li>
            <li>Teaching mathematical concepts with examples</li>
            <li>Answering questions like "What is...?" or "How does...?"</li>
            <li>Checking your work and explaining calculations</li>
          </ul>
          <p style="margin-top: 8px; font-size: 13px; color: #666;">Try asking: "What are prime numbers?", "Explain the Pythagorean theorem", "What is calculus?", or any math question!</p>
        </div>
      </div>
      <div class="input-area">
        <input type="text" id="aiInput" class="ai-input" placeholder="Ask me: What are prime numbers? What is calculus?" />
        <button class="send-btn" id="sendBtn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="panel-content" id="equationPanel">
      <div class="equation-solver">
        <div class="equation-input-section">
          <h3>Enter Your Equation:</h3>
          <input type="text" id="equationInput" class="equation-input" placeholder="Example: 2x + 5 = 13" />
          <div class="equation-examples">
            <strong>Examples:</strong>
            <div>‚Ä¢ Linear: 2x + 5 = 13</div>
            <div>‚Ä¢ Quadratic: x^2 - 5x + 6 = 0</div>
            <div>‚Ä¢ Multiple variables: 2x + 3y = 12 and x - y = 1</div>
          </div>
        </div>

        <button class="solve-btn" id="solveBtn">Solve with AI</button>

        <div class="solution-area">
          <h3>Solution:</h3>
          <div class="solution-content" id="solutionContent">
            Enter an equation above and click "Solve with AI" to see the step-by-step solution!
          </div>
        </div>
      </div>
    </div>

    <div class="panel-content" id="historyPanel">
      <div class="combined-history">
        <div class="history-section">
          <h3>
            Calculation History
            <button class="clear-btn" id="clearHistoryBtn">Clear</button>
          </h3>
          <div id="historyList">
            <div class="no-history">No calculations yet</div>
          </div>
        </div>

        <div class="history-section">
          <h3>
            Memory
            <button class="clear-btn" id="clearMemoryBtn">Clear</button>
          </h3>
          <div id="memoryList">
            <div class="no-memory">No memory stored</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentVal = '0';
    let previousVal = null;
    let operator = null;
    let waitingForOperand = false;
    let memoryVal = 0;
    let lastCalculation = '';
    let calculationHistory = [];
    let conversationHistory = [];

    const displayEl = document.getElementById('display');
    const historyEl = document.getElementById('history');
    const chatArea = document.getElementById('chatArea');
    const aiInput = document.getElementById('aiInput');
    const sendBtn = document.getElementById('sendBtn');
    const equationInput = document.getElementById('equationInput');
    const solveBtn = document.getElementById('solveBtn');
    const solutionContent = document.getElementById('solutionContent');
    const memoryList = document.getElementById('memoryList');
    const historyList = document.getElementById('historyList');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    const clearMemoryBtn = document.getElementById('clearMemoryBtn');
    const historyToggle = document.getElementById('historyToggle');

    // Panel tab switching
    document.querySelectorAll('.panel-tab').forEach(tab => {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel-content').forEach(c => c.classList.remove('active'));
        
        this.classList.add('active');
        const tabName = this.dataset.tab;
        document.getElementById(tabName + 'Panel').classList.add('active');
        
        if (tabName === 'history') {
          updateHistoryDisplay();
          updateMemoryDisplay();
        }
      });
    });

    historyToggle.onclick = function() {
      document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.panel-content').forEach(c => c.classList.remove('active'));
      document.querySelector('.panel-tab[data-tab="history"]').classList.add('active');
      document.getElementById('historyPanel').classList.add('active');
      updateHistoryDisplay();
      updateMemoryDisplay();
    };

    function updateHistoryDisplay() {
      if (calculationHistory.length === 0) {
        historyList.innerHTML = '<div class="no-history">No calculations yet</div>';
      } else {
        historyList.innerHTML = calculationHistory.map((item, index) => `
          <div class="history-item" data-index="${index}">
            <div class="history-expression">${item.expression}</div>
            <div class="history-result">= ${item.result}</div>
          </div>
        `).reverse().join('');
        
        document.querySelectorAll('.history-item').forEach(item => {
          item.addEventListener('click', function() {
            const index = parseInt(this.dataset.index);
            useHistoryResult(index);
          });
        });
      }
    }

    function useHistoryResult(index) {
      const item = calculationHistory[calculationHistory.length - 1 - index];
      setDisplay(item.result);
      document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.panel-content').forEach(c => c.classList.remove('active'));
      document.querySelector('.panel-tab[data-tab="chatgpt"]').classList.add('active');
      document.getElementById('chatgptPanel').classList.add('active');
    }

    clearHistoryBtn.onclick = function() {
      calculationHistory = [];
      updateHistoryDisplay();
    };

    clearMemoryBtn.onclick = function() {
      memoryVal = 0;
      updateMemoryDisplay();
    };

    function updateMemoryDisplay() {
      if (memoryVal === 0) {
        memoryList.innerHTML = '<div class="no-memory">No memory stored</div>';
      } else {
        memoryList.innerHTML = `<div class="memory-item" id="memoryItem">M = ${memoryVal}</div>`;
        document.getElementById('memoryItem').addEventListener('click', useMemoryValue);
      }
    }

    function useMemoryValue() {
      setDisplay(String(memoryVal));
      document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.panel-content').forEach(c => c.classList.remove('active'));
      document.querySelector('.panel-tab[data-tab="chatgpt"]').classList.add('active');
      document.getElementById('chatgptPanel').classList.add('active');
    }

    function setDisplay(val) {
      currentVal = String(val);
      displayEl.value = currentVal;
    }

    function setHistory(text) {
      historyEl.textContent = text || '\u00A0';
    }

    function addMessage(text, isUser) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + (isUser ? 'user-message' : 'ai-message');
      msgDiv.textContent = text;
      chatArea.appendChild(msgDiv);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    function showLoading() {
      const loadDiv = document.createElement('div');
      loadDiv.className = 'loading';
      loadDiv.id = 'loadingMsg';
      loadDiv.innerHTML = '<span style="animation: pulse 1.5s ease-in-out infinite;">‚óè</span> Claude is thinking...';
      chatArea.appendChild(loadDiv);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    function removeLoading() {
      const loadDiv = document.getElementById('loadingMsg');
      if (loadDiv) loadDiv.remove();
    }

    async function askChatGPT(question, isCalculation = false) {
      try {
        showLoading();
        
        // Build prompt based on context
        let userMessage = question;
        let systemPrompt = "You are a comprehensive math tutor and calculator assistant. You can explain ANY mathematical concept, from basic arithmetic to advanced mathematics. When users ask 'what is X' or 'explain Y', provide clear, detailed explanations with examples. Topics include: prime numbers, fractions, algebra, geometry, calculus, trigonometry, statistics, number theory, and more. When explaining calculations, be brief (2-3 sentences). For concept questions, provide thorough explanations with examples and real-world applications. Always be educational, clear, and encouraging.";
        
        if (isCalculation) {
          userMessage = `I just performed this calculation: ${question}. Please explain it briefly and clearly in 2-3 sentences.`;
        }
        
        // Add to conversation history
        conversationHistory.push({
          role: "user",
          content: userMessage
        });
        
        // Call Claude API
        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 2000,
            system: systemPrompt,
            messages: conversationHistory
          })
        });

        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`);
        }

        const data = await response.json();
        
        // Check for API errors
        if (data.error) {
          throw new Error(data.error.message || "API request failed");
        }
        
        // Extract response text
        let aiResponse = '';
        if (data.content && data.content.length > 0) {
          aiResponse = data.content
            .filter(item => item.type === "text")
            .map(item => item.text)
            .join("\n");
        }
        
        if (!aiResponse) {
          throw new Error("Empty response from API");
        }
        
        // Add AI response to conversation history
        conversationHistory.push({
          role: "assistant",
          content: aiResponse
        });
        
        // Keep conversation history manageable (last 12 messages)
        if (conversationHistory.length > 12) {
          conversationHistory = conversationHistory.slice(-12);
        }
        
        removeLoading();
        addMessage(aiResponse, false);
        
      } catch (error) {
        console.error("API Error:", error);
        removeLoading();
        
        // Remove the failed user message from history
        if (conversationHistory.length > 0 && conversationHistory[conversationHistory.length - 1].role === "user") {
          conversationHistory.pop();
        }
        
        // Provide helpful error message based on error type
        let errorMessage = '';
        
        if (error.message.includes('API Error') || error.message.includes('Failed to fetch')) {
          errorMessage = "‚ö†Ô∏è AI Connection Error: The Claude AI service is currently unavailable. This calculator works best when used directly on claude.ai. You can still use all calculator functions normally!";
        } else {
          errorMessage = "‚ö†Ô∏è Oops! I encountered an issue. Please try again or rephrase your question. The calculator functions work perfectly!";
        }
        
        addMessage(errorMessage, false);
      }
    }

    async function solveChatGPT(equation) {
      try {
        solveBtn.disabled = true;
        solutionContent.textContent = 'Claude is solving your equation...';
        
        // Call Claude API for equation solving
        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "anthropic-version": "2023-06-01"
          },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 1000,
            system: "You are a math tutor helping solve equations. Provide step-by-step solutions with clear explanations. Format your response with headers like 'Step 1:', 'Step 2:', etc. Show all work and verify the solution at the end.",
            messages: [
              {
                role: "user",
                content: `Please solve this equation step-by-step: ${equation}

Provide:
1. The complete step-by-step solution
2. Explanation of each step
3. Verification of the answer
4. The final answer clearly marked

Format it clearly with headers and steps.`
              }
            ]
          })
        });

        const data = await response.json();
        
        // Check for API errors
        if (data.error) {
          console.error("API Error:", data.error);
          throw new Error(data.error.message || "API request failed");
        }
        
        // Extract solution text
        let solution = '';
        if (data.content && Array.isArray(data.content) && data.content.length > 0) {
          solution = data.content
            .filter(item => item.type === "text")
            .map(item => item.text)
            .join("\n");
        }
        
        if (!solution) {
          throw new Error("No solution content received");
        }
        
        solutionContent.textContent = solution;
        
      } catch (error) {
        console.error("Equation solver error:", error);
        
        const errorMessage = `ü§ñ Claude AI Equation Solver

This feature uses Claude AI to solve equations with step-by-step explanations!

‚úÖ Works perfectly in claude.ai where Claude can:
‚Ä¢ Solve any equation (linear, quadratic, systems, etc.)
‚Ä¢ Show detailed step-by-step solutions
‚Ä¢ Explain each step clearly
‚Ä¢ Verify the answers

üì± To use this feature:
1. Use this calculator in claude.ai
2. Or ask your equation in the AI Assistant chat tab
3. I'll solve it with full explanations!

üí° The calculator buttons work perfectly everywhere!`;
        
        solutionContent.textContent = errorMessage;
      } finally {
        solveBtn.disabled = false;
      }
    }

    sendBtn.onclick = async function() {
      const question = aiInput.value.trim();
      if (!question) return;
      
      addMessage(question, true);
      aiInput.value = '';
      sendBtn.disabled = true;
      
      await askChatGPT(question);
      sendBtn.disabled = false;
    };

    aiInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendBtn.click();
      }
    });

    solveBtn.onclick = function() {
      const equation = equationInput.value.trim();
      if (!equation) {
        solutionContent.textContent = 'Please enter an equation first!';
        return;
      }
      solveChatGPT(equation);
    };

    equationInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        solveBtn.click();
      }
    });

    function inputDigit(digit) {
      if (waitingForOperand) {
        setDisplay(digit);
        waitingForOperand = false;
      } else {
        setDisplay(currentVal === '0' ? digit : currentVal + digit);
      }
    }

    function inputDecimal() {
      if (waitingForOperand) {
        setDisplay('0.');
        waitingForOperand = false;
      } else if (currentVal.indexOf('.') === -1) {
        setDisplay(currentVal + '.');
      }
    }

    function clearAll() {
      setDisplay('0');
      setHistory('');
      previousVal = null;
      operator = null;
      waitingForOperand = false;
    }

    function clearEntry() {
      setDisplay('0');
    }

    function backspace() {
      const newVal = currentVal.slice(0, -1);
      setDisplay(newVal || '0');
    }

    function performOperation(nextOperator) {
      const inputValue = parseFloat(currentVal);

      if (previousVal === null) {
        previousVal = inputValue;
      } else if (operator) {
        const result = calculate(previousVal, inputValue, operator);
        setDisplay(String(result));
        previousVal = result;
      }

      waitingForOperand = true;
      operator = nextOperator;
      
      const opSymbol = {
        'ADD': '+',
        'SUBTRACT': '‚àí',
        'MULTIPLY': '√ó',
        'DIVIDE': '√∑'
      }[nextOperator];
      
      setHistory(previousVal + ' ' + opSymbol);
    }

    function calculate(firstOperand, secondOperand, op) {
      switch(op) {
        case 'ADD':
          return firstOperand + secondOperand;
        case 'SUBTRACT':
          return firstOperand - secondOperand;
        case 'MULTIPLY':
          return firstOperand * secondOperand;
        case 'DIVIDE':
          if (secondOperand === 0) {
            setHistory('');
            return 'Cannot divide by zero';
          }
          return firstOperand / secondOperand;
        default:
          return secondOperand;
      }
    }

    function performEquals() {
      const inputValue = parseFloat(currentVal);

      if (previousVal !== null && operator) {
        const result = calculate(previousVal, inputValue, operator);
        
        const opSymbol = {
          'ADD': '+',
          'SUBTRACT': '‚àí',
          'MULTIPLY': '√ó',
          'DIVIDE': '√∑'
        }[operator];
        
        const expression = previousVal + ' ' + opSymbol + ' ' + inputValue;
        lastCalculation = expression + ' = ' + result;
        
        calculationHistory.push({
          expression: expression,
          result: result
        });
        
        setHistory(lastCalculation);
        setDisplay(String(result));
        
        // Check for 9/11 easter egg
        const is911 = (previousVal === 9 && inputValue === 11 && operator === 'DIVIDE');
        
        addMessage(`I just calculated: ${lastCalculation}`, true);
        askChatGPT(`Explain this calculation briefly: ${lastCalculation}. Keep it simple and short.`, true);
        
        // Add airplane emoji for 9/11
        if (is911) {
          setTimeout(() => {
            const emojiDiv = document.createElement('div');
            emojiDiv.className = 'message ai-message';
            emojiDiv.style.fontSize = '48px';
            emojiDiv.style.textAlign = 'center';
            emojiDiv.textContent = '‚úàÔ∏è';
            chatArea.appendChild(emojiDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
          }, 1500);
        }
        
        previousVal = null;
        operator = null;
        waitingForOperand = true;
      }
    }

    function performFunction(fn) {
      const inputValue = parseFloat(currentVal);
      let result;
      let explanation = '';

      switch(fn) {
        case 'PERCENT':
          result = inputValue / 100;
          explanation = `${inputValue}% = ${result}`;
          break;
        case 'RECIPROCAL':
          if (inputValue === 0) {
            result = 'Cannot divide by zero';
          } else {
            result = 1 / inputValue;
            explanation = `1/${inputValue} = ${result}`;
          }
          break;
        case 'SQUARE':
          result = inputValue * inputValue;
          explanation = `${inputValue}¬≤ = ${result}`;
          break;
        case 'SQRT':
          if (inputValue < 0) {
            result = 'Invalid input';
          } else {
            result = Math.sqrt(inputValue);
            explanation = `‚àö${inputValue} = ${result}`;
          }
          break;
        case 'NEGATE':
          result = -inputValue;
          break;
      }

      setDisplay(String(result));
      
      if (fn !== 'NEGATE' && explanation) {
        addMessage(`I just calculated: ${explanation}`, true);
        askChatGPT(`Explain this calculation briefly: ${explanation}. Keep it simple and short.`, true);
      }
      
      if (fn !== 'NEGATE') {
        waitingForOperand = true;
      }
    }

    // Number buttons
    document.getElementById('n0').onclick = () => inputDigit('0');
    document.getElementById('n1').onclick = () => inputDigit('1');
    document.getElementById('n2').onclick = () => inputDigit('2');
    document.getElementById('n3').onclick = () => inputDigit('3');
    document.getElementById('n4').onclick = () => inputDigit('4');
    document.getElementById('n5').onclick = () => inputDigit('5');
    document.getElementById('n6').onclick = () => inputDigit('6');
    document.getElementById('n7').onclick = () => inputDigit('7');
    document.getElementById('n8').onclick = () => inputDigit('8');
    document.getElementById('n9').onclick = () => inputDigit('9');
    document.getElementById('decimal').onclick = () => inputDecimal();

    // Operator buttons
    document.getElementById('add').onclick = () => performOperation('ADD');
    document.getElementById('subtract').onclick = () => performOperation('SUBTRACT');
    document.getElementById('multiply').onclick = () => performOperation('MULTIPLY');
    document.getElementById('divide').onclick = () => performOperation('DIVIDE');
    document.getElementById('equals').onclick = () => performEquals();

    // Function buttons
    document.getElementById('clear').onclick = () => clearAll();
    document.getElementById('ce').onclick = () => clearEntry();
    document.getElementById('back').onclick = () => backspace();
    document.getElementById('percent').onclick = () => performFunction('PERCENT');
    document.getElementById('recip').onclick = () => performFunction('RECIPROCAL');
    document.getElementById('square').onclick = () => performFunction('SQUARE');
    document.getElementById('sqrt').onclick = () => performFunction('SQRT');
    document.getElementById('negate').onclick = () => performFunction('NEGATE');

    // Memory buttons
    document.getElementById('mc').onclick = () => {
      memoryVal = 0;
      updateMemoryDisplay();
    };
    
    document.getElementById('mr').onclick = () => {
      setDisplay(String(memoryVal));
    };
    
    document.getElementById('mAdd').onclick = () => {
      memoryVal += parseFloat(currentVal);
      updateMemoryDisplay();
    };
    
    document.getElementById('mSub').onclick = () => {
      memoryVal -= parseFloat(currentVal);
      updateMemoryDisplay();
    };
    
    document.getElementById('ms').onclick = () => {
      memoryVal = parseFloat(currentVal);
      updateMemoryDisplay();
    };
  </script>
</body>
</html>
